syntax = "proto3";

package insightify.v1;

import "pipeline/v1/client_view.proto";

option go_package = "insightifyv1";

service PipelineService {
  // Initialize a run session from frontend-provided context.
  rpc InitRun(InitRunRequest) returns (InitRunResponse);

  // List projects owned by a user.
  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse);

  // Create a new project for a user.
  rpc CreateProject(CreateProjectRequest) returns (CreateProjectResponse);

  // Set an existing project as the active project for a user.
  rpc SelectProject(SelectProjectRequest) returns (SelectProjectResponse);

  // Start executing a plan. Returns immediately with a run_id.
  rpc StartRun(StartRunRequest) returns (StartRunResponse);

  // Respond to a pending user-input request for an interactive run.
  rpc NeedUserInput(SubmitRunInputRequest) returns (SubmitRunInputResponse);

  // Streaming progress for a run (fan out to UI).
  rpc WatchRun(WatchRunRequest) returns (stream WatchRunResponse);
}

message InitRunRequest {
  string user_id = 1;
  string repo_url = 2;
  string project_id = 3;
}

message InitRunResponse {
  string session_id = 1;
  string repo_name = 2;
  string bootstrap_run_id = 3;
  string project_id = 4;
}

message Project {
  string project_id = 1;
  string user_id = 2;
  string name = 3;
  string repo_url = 4;
  string purpose = 5;
  string repo_name = 6;
  bool is_active = 7;
}

message ListProjectsRequest {
  string user_id = 1;
}

message ListProjectsResponse {
  repeated Project projects = 1;
  string active_project_id = 2;
}

message CreateProjectRequest {
  string user_id = 1;
  string name = 2;
  string repo_url = 3;
}

message CreateProjectResponse {
  Project project = 1;
}

message SelectProjectRequest {
  string user_id = 1;
  string project_id = 2;
}

message SelectProjectResponse {
  Project project = 1;
}

message StartRunRequest {
  string session_id = 1;
  string pipeline_id = 2;
  map<string, string> params = 3;
  string project_id = 4;
}

message StartRunResponse {
  string run_id = 1;
  pipeline.v1.ClientView client_view = 2;
}

message SubmitRunInputRequest {
  string session_id = 1;
  string run_id = 2;
  string input = 3;
  string project_id = 4;
}

message SubmitRunInputResponse {
  string run_id = 1;
}

message WatchRunRequest {
  string run_id = 1;
}

message WatchRunResponse {
  enum EventType {
    EVENT_TYPE_UNSPECIFIED = 0;
    EVENT_TYPE_LOG = 1;
    EVENT_TYPE_PROGRESS = 2;
    EVENT_TYPE_COMPLETE = 3;
    EVENT_TYPE_ERROR = 4;
  }
  EventType event_type = 1;
  string message = 2;
  int32 progress_percent = 3;
  pipeline.v1.ClientView client_view = 4; // Set when event_type is COMPLETE
}
