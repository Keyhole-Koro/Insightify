syntax = "proto3";

package insightify.v1;

option go_package = "insightifyv1";

// UI node types and state â€” shared across services.

service UiService {
  rpc GetDocument(GetUiDocumentRequest) returns (GetUiDocumentResponse);
  rpc ApplyOps(ApplyUiOpsRequest) returns (ApplyUiOpsResponse);
}

service UiWorkspaceService {
  rpc GetWorkspace(GetUiWorkspaceRequest) returns (GetUiWorkspaceResponse);
  rpc ListTabs(ListUiTabsRequest) returns (ListUiTabsResponse);
  rpc CreateTab(CreateUiTabRequest) returns (CreateUiTabResponse);
  rpc SelectTab(SelectUiTabRequest) returns (SelectUiTabResponse);
  rpc Restore(RestoreUiRequest) returns (RestoreUiResponse);
}

enum UiNodeType {
  UI_NODE_TYPE_UNSPECIFIED = 0;
  UI_NODE_TYPE_LLM_CHAT = 1;
  UI_NODE_TYPE_MARKDOWN = 2;
  UI_NODE_TYPE_IMAGE = 3;
  UI_NODE_TYPE_TABLE = 4;
}

message UiNodeMeta {
  string title = 1;
  string description = 2;
  repeated string tags = 3;
}

message UiChatMessage {
  enum Role {
    ROLE_UNSPECIFIED = 0;
    ROLE_USER = 1;
    ROLE_ASSISTANT = 2;
  }

  string id = 1;
  Role role = 2;
  string content = 3;
}

message UiLlmChatState {
  string model = 1;
  bool is_responding = 2;
  bool send_locked = 3;
  string send_lock_hint = 4;
  repeated UiChatMessage messages = 5;
}

message UiMarkdownState {
  string markdown = 1;
}

message UiImageState {
  string src = 1;
  string alt = 2;
}

message UiTableState {
  repeated string columns = 1;
  repeated UiTableRow rows = 2;
}

message UiTableRow {
  repeated string cells = 1;
}

message UiNode {
  string id = 1;
  UiNodeType type = 2;
  UiNodeMeta meta = 3;
  UiLlmChatState llm_chat = 10;
  UiMarkdownState markdown = 11;
  UiImageState image = 12;
  UiTableState table = 13;
}

message UiDocument {
  string run_id = 1;
  int64 version = 2;
  repeated UiNode nodes = 3;
}

message GetUiDocumentRequest {
  string run_id = 1;
}

message GetUiDocumentResponse {
  UiDocument document = 1;
}

message UiWorkspace {
  string workspace_id = 1;
  string project_id = 2;
  string name = 3;
  string active_tab_id = 4;
}

message UiWorkspaceTab {
  string tab_id = 1;
  string workspace_id = 2;
  string title = 3;
  string run_id = 4;
  int32 order_index = 5;
  bool is_pinned = 6;
  int64 created_at_unix_ms = 7;
}

message GetUiWorkspaceRequest {
  string project_id = 1;
}

message GetUiWorkspaceResponse {
  UiWorkspace workspace = 1;
  repeated UiWorkspaceTab tabs = 2;
}

message ListUiTabsRequest {
  string project_id = 1;
}

message ListUiTabsResponse {
  UiWorkspace workspace = 1;
  repeated UiWorkspaceTab tabs = 2;
}

message CreateUiTabRequest {
  string project_id = 1;
  string title = 2;
}

message CreateUiTabResponse {
  UiWorkspace workspace = 1;
  UiWorkspaceTab tab = 2;
  repeated UiWorkspaceTab tabs = 3;
}

message SelectUiTabRequest {
  string project_id = 1;
  string tab_id = 2;
}

message SelectUiTabResponse {
  UiWorkspace workspace = 1;
  repeated UiWorkspaceTab tabs = 2;
}

enum UiRestoreReason {
  UI_RESTORE_REASON_UNSPECIFIED = 0;
  UI_RESTORE_REASON_RESOLVED = 1;
  UI_RESTORE_REASON_NO_TAB = 2;
  UI_RESTORE_REASON_NO_RUN = 3;
  UI_RESTORE_REASON_ERROR = 4;
}

message RestoreUiRequest {
  string project_id = 1;
  string tab_id = 2;
}

message RestoreUiResponse {
  bool found = 1;
  bool restored = 2;
  UiRestoreReason reason = 3;
  string project_id = 4;
  string tab_id = 5;
  string run_id = 6;
  UiDocument document = 7;
}

message ApplyUiOpsRequest {
  string run_id = 1;
  int64 base_version = 2;
  repeated UiOp ops = 3;
  string actor = 4;
}

message ApplyUiOpsResponse {
  UiDocument document = 1;
  bool conflict = 2;
  int64 current_version = 3;
  string conflict_message = 4;
}

message UiOp {
  oneof action {
    UiUpsertNode upsert_node = 1;
    UiDeleteNode delete_node = 2;
    UiClearNodes clear_nodes = 3;
  }
}

message UiUpsertNode {
  UiNode node = 1;
}

message UiDeleteNode {
  string node_id = 1;
}

message UiClearNodes {}
